<html>
    <head>
        <link rel="stylesheet" type="text/css" href="./css/bootstrap.css">
        <script src="http://js.pusher.com/1.12/pusher.min.js"></script>
        <script src="./js/jquery.js"></script>
        <script src="./js/jquery.tmpl.js"></script>
		<script src="./js/PusherActivityStreamer.js"></script>
		
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
		<style>
			#map-canvas img {
				max-width: none;
			}
		</style>
		<script>
			var map;
			function initialize() {
				var mapOptions = {
					zoom: 12,
					center: new google.maps.LatLng(-34.397, 150.644),
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
			}
			var markers = [];
			function updateMap(lat,lon,name,user,zoom) {
				if (!zoom) {
					zoom = 12
				}
				coords = new google.maps.LatLng(lat,lon);
				var currentMarker = markers.length;
				markers[currentMarker] = {}
				var contentString = "This is the popup";
				markers[currentMarker]['infoWindow'] = new google.maps.InfoWindow({
					content: contentString
				});
				markers[currentMarker]['marker'] = new google.maps.Marker({
					map:map,
					draggable:false,
					animation: google.maps.Animation.DROP,
					position: coords,
					title: name
				});
				
				google.maps.event.addListener(markers[currentMarker]['marker'], 'click', function() {
					markers[currentMarker]['infoWindow'].open(map,markers[currentMarker]['marker']);
				});
				
			}
			google.maps.event.addDomListener(window, 'load', initialize);
			
		</script>
		
        <script type="text/javascript">
			// Enable pusher logging - don't include this in production
			Pusher.log = function(message) {
			  if (window.console && window.console.log) window.console.log(message);
			};

			// Flash fallback logging - don't include this in production
			WEB_SOCKET_DEBUG = true;
			
			var pusher = new Pusher('04af48f0bd881f9f9737');
			var channel = pusher.subscribe('e41bb781-531d-4354-a840-777e267a809e');
			
			var messages=[];
			channel.bind('HunterJoined', function(data) {
				HunterJoined(data);
			});
			
			channel.bind('HuntMessage', function(data) {
				HuntMessage(data);
			});
			
			channel.bind('foundItem', function(data) {
			  console.log(data);
			  messages[messages.length] = data;
			  
			  updateMap(data['lat'],data['long'],data['name'])
			  
			  
			});
			
			function message(data) {
				if (!data.profileImage)
					data.profileImage = "./img/noprofile.jpg";
				$('#clientTemplate').tmpl(data).hide().prependTo('#sidebar').fadeIn();;
			}
			
			function HuntMessage(data) {
				if (!data.name)
					data.name = "Hunt Facilitator";
				messageObj = data
				messageObj['message'] = data.name + " says " + data.message;
				message(messageObj);
			}
			function HunterJoined(data) {
				messageObj = data
				messageObj['message'] = data.name + " has just joined the hunt!";
				message(messageObj);
			}
			
			function message(data) {
				if (!data.profileImageUrl)
					data.profileImageUrl = "./img/noprofile.jpg";
				$('#clientTemplate').tmpl(data).hide().prependTo('#sidebar').fadeIn();;
			}
			
		</script>
		
		<script id="clientTemplate" type="text/html">
			<div id="action">
				<img id="userIcon" src="${profileImageUrl}" />
				<span id="userAction">${message}</span><br>
				<span id="timestamp">${timestamp}</span>
			</div>
		</script>
		
        <style>
			body {
				background:url(./img/background.jpg) #385b8c;
				background-repeat:repeat-x;
				color:#ccc;
				margin:0px;
				padding:0px;
			}
            #logo {
                text-align:center;
				background:url(./img/texture.jpg);
				background-repeat:repeat-x;
				border-bottom:2px solid #000;
                padding-top:10px;
                padding-bottom:10px;
            }
            #items, #sidebar {
				background:#f1f1f1;
				color:#1f1f1f;
				padding:10px;
			}
			#header {
				margin-bottom:0px;
			}
			#map-canvas {
				height:500px;
			}
			#action {
				border:1px solid #ccc;
				height:50px;
				background:#bfdaff;
				overflow:hidden;
				margin-top:5px;
			}
			#userIcon {
				height:50px;
				padding-right:
			}
			#userAction {
				width:100%;
			}
			#timestamp {
				
			}
        </style>
    </head>
    <body>
        
        
        
        <div class="row-fluid" id='header'>
            <div class="span12" id='logo'><img src='./img/hunt.png' /></div>
        </div>
        <div class="row-fluid">
			<div class='span12' id='map-canvas'></div>
		</div>
        <div class="row-fluid">
            <div id="items" class="span8">
                <div id='capture'>
                    <div class='row'>
						<div class='span2' id='icon'>No Icon</div>
						<div class='span8' id='discription'>
							Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus vel lectus quis augue molestie adipiscing nec non augue. Mauris placerat consequat lorem eget dictum. Proin quis tincidunt leo. Etiam convallis iaculis diam a consectetur. Curabitur metus nisl, suscipit a cursus vel, pharetra ac odio. Fusce.
						</div>
						<div class='span2' id='status'>X</div>
					</div>
					<center>
						<input type="file" id="uploadPicture" accept="image/*" capture="camera" style='display:none;'>
						<input type='button' onclick="$('#uploadPicture').click()" value='I Found It' />
					</center>
                </div>
				
				<a href="#" onclick="HunterJoined({'profileImageUrl':'http://www.gravatar.com/avatar/b068931cc450442b63f5b3d276ea4297?s=80&d=mm&r=g','name':'Britt Gresham','timestamp':'NOW IS THE TIME'})">Join Hunt</a>
				<a href="#" onclick="updateMap(-34.397, 150.644, 'null')">Add Pin</a>
				
            </div>
			
            <div id="sidebar" class="span4">
				
			</div>
        </div>
    </body>
</html>